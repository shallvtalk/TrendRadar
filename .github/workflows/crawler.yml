name: Hot News Crawler  # å·¥ä½œæµåç§°

on:  # è§¦å‘æ¡ä»¶å®šä¹‰
  schedule:  # å®šæ—¶ä»»åŠ¡é…ç½®
    # æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ GitHub å®˜æ–¹æä¾›çš„èµ„æºæ¥è¿›è¡Œæ¨é€ï¼Œæ¯ä¸ªè´¦å·çš„èµ„æºæœ‰é¢åº¦é™åˆ¶ï¼Œä¸ºäº†é¿å…è¢«è®¤å®šæ»¥ç”¨è€Œå°å·ï¼Œä¸å»ºè®®é¢‘ç‡ä½äºåŠå°æ—¶
    - cron: "0 0 * * *" # GitHub Actions é‡‡ç”¨ UTCï¼Œ0 ç‚¹å¯¹åº”åŒ—äº¬æ—¶é—´(UTC+8)æ—©ä¸Š 8 ç‚¹
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# æ·»åŠ æƒé™è®¾ç½®
permissions:  # é…ç½®ä½œä¸šæ‰€éœ€æƒé™
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹

jobs:  # å®šä¹‰æ‰€æœ‰ä½œä¸š
  crawl:  # å•ä¸ªæŠ“å–ä½œä¸š
    runs-on: ubuntu-latest  # ä½¿ç”¨ GitHub æä¾›çš„æœ€æ–°ç‰ˆ Ubuntu runner

    steps:  # ä½œä¸šæ­¥éª¤åˆ—è¡¨
      - name: Checkout repository  # æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3  # ä½¿ç”¨å®˜æ–¹ checkout åŠ¨ä½œ

      - name: Set up Python  # è®¾ç½® Python è¿è¡Œç¯å¢ƒ
        uses: actions/setup-python@v4  # å®‰è£… Python çš„ GitHub Action
        with:  # ä¼ é€’å‚æ•°
          python-version: "3.10"  # æŒ‡å®šä½¿ç”¨ Python 3.10

      - name: Install dependencies  # å®‰è£…ä¾èµ–
        run: |  # è¿è¡Œå¤šè¡Œ shell æŒ‡ä»¤
          python -m pip install --upgrade pip  # å‡çº§ pip è‡³æœ€æ–°ç‰ˆæœ¬
          pip install -r requirements.txt  # æ ¹æ® requirements.txt å®‰è£…ä¾èµ–

      - name: Verify required files  # ç¡®è®¤æ‰€éœ€é…ç½®å­˜åœ¨
        run: |  # æ‰§è¡Œæ£€æŸ¥è„šæœ¬
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„é…ç½®æ–‡ä»¶..." # æç¤ºæ­£åœ¨æ£€æŸ¥

          if [ ! -f config/config.yaml ]; then # åˆ¤æ–­é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            echo "âŒé”™è¯¯: config/config.yaml æ–‡ä»¶ä¸å­˜åœ¨" # æç¤ºç¼ºå¤±
            echo "è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£åˆ›å»ºé…ç½®æ–‡ä»¶" # å¼•å¯¼ç”¨æˆ·åˆ›å»º
            exit 1 # ç»ˆæ­¢è¿è¡Œ
          fi # ç»“æŸç¬¬ä¸€ä¸ªåˆ¤æ–­

          if [ ! -f config/frequency_words.txt ]; then # åˆ¤æ–­é¢‘ç‡è¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            echo "âŒé”™è¯¯: config/frequency_words.txt æ–‡ä»¶ä¸å­˜åœ¨" # æç¤ºç¼ºå¤±
            echo "è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£åˆ›å»ºé¢‘ç‡è¯é…ç½®æ–‡ä»¶" # å¼•å¯¼åˆ›å»º
            exit 1 # ç»ˆæ­¢è¿è¡Œ
          fi # ç»“æŸç¬¬äºŒä¸ªåˆ¤æ–­

          echo "âœ…é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡" # æ£€æŸ¥æˆåŠŸæç¤º

      - name: Run crawler  # æ‰§è¡Œçˆ¬è™«ä¸»ç¨‹åº
        env:  # ä¼ å…¥è¿è¡Œæ‰€éœ€çš„ç¯å¢ƒå˜é‡
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}  # é£ä¹¦æœºå™¨äººåœ°å€
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}  # Telegram æœºå™¨äººä»¤ç‰Œ
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  # ç›®æ ‡ Telegram èŠå¤© ID
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}  # é’‰é’‰æœºå™¨äººåœ°å€
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}  # ä¼ä¸šå¾®ä¿¡æœºå™¨äººåœ°å€
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}  # é‚®ä»¶å‘é€è€…
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}  # é‚®ä»¶å¯†ç æˆ–æˆæƒç 
          EMAIL_TO: ${{ secrets.EMAIL_TO }}  # é‚®ä»¶æ¥æ”¶è€…
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}  # SMTP æœåŠ¡å™¨
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}  # SMTP ç«¯å£
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}  # ntfy æ¨é€ä¸»é¢˜
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}  # ntfy æœåŠ¡å™¨åœ°å€
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}  # ntfy é‰´æƒ Token
          GITHUB_ACTIONS: true  # æ ‡è®°ç¨‹åºè¿è¡Œåœ¨ GitHub Actions
        run: python main.py  # æ‰§è¡Œä¸»è„šæœ¬

      - name: Commit and push if changes  # å¦‚æœ‰æ›´æ”¹åˆ™æäº¤
        run: |  # æ‰§è¡Œ Git æäº¤è„šæœ¬
          git config --global user.name 'GitHub Actions' # é…ç½®æäº¤ç”¨æˆ·
          git config --global user.email 'actions@github.com' # é…ç½®æäº¤é‚®ç®±
          git add -A # æš‚å­˜æ‰€æœ‰æ”¹åŠ¨
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)" && git push) # æœ‰å˜æ›´åˆ™æäº¤å¹¶æ¨é€
